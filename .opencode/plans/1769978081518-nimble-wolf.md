# Plan: opencode-copilot-messages Plugin

## Overview

Create an optional plugin `opencode-copilot-messages` that provides an alternate auth/routing path for Claude models via Copilot's `/v1/messages` proxy endpoint (`api.copilot.com/v1/messages`). This uses the Anthropic Messages API format with `@ai-sdk/anthropic` and requires different credentials than the standard Copilot `/chat/completions` path.

**Provider ID:** `copilot-messages`
**Package Name:** `opencode-copilot-messages`

---

## Key Differences from Standard Copilot

| Aspect     | Standard Copilot         | This Plugin            |
| ---------- | ------------------------ | ---------------------- |
| Endpoint   | `/chat/completions`      | `/v1/messages`         |
| Client ID  | `Ov23li8tweQw6odWQebz`   | `Iv1.b507a08c87ecfe98` |
| SDK        | `@ai-sdk/github-copilot` | `@ai-sdk/anthropic`    |
| API Format | OpenAI Chat Completions  | Anthropic Messages API |
| Models     | All Copilot models       | Claude 4.x only        |

---

## Critical Implementation Notes (from review)

### Blocking Issues - Resolved

1. **Base URL**: Must be `https://api.copilot.com/v1` (include `/v1`) because `@ai-sdk/anthropic` appends `/messages`

2. **API Key Requirement**: Set `apiKey: ""` (empty string) and strip `x-api-key` header in custom fetch (matches existing Copilot plugin pattern)

3. **X-Initiator Logic**: Check only the **LAST** content block - if it's `tool_result`, use `agent`. Not "any tool_result in message".

4. **Subagent Sessions**: Use `chat.headers` hook to detect subagent sessions and force `X-Initiator: agent`

5. **Provider Registration**: Use `config` hook to inject provider entry:

   ```typescript
   hooks.config = async (config) => {
     config.provider ??= {};
     config.provider["copilot-messages"] = {
       name: "Copilot Messages",
       api: { name: "Anthropic" },
       models: {},
     };
   };
   ```

6. **Model Mapping Shape**: Use `limit.context` and `limit.output` (not top-level `context`)

### High-Risk Items - Resolved

7. **Vision Requests**: Include `Copilot-Vision-Request: true` header when images present

8. **Session Token Expiry**: Use VSCode pattern: `expires_at = now + refresh_in + 60` (handles clock skew)

9. **OAuth Scope**: Use `read:user` (minimal scope)

10. **Intent Headers**: Use `messages-proxy` for both `X-Interaction-Type` and `OpenAI-Intent`

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│  opencode-copilot-messages                                  │
├─────────────────────────────────────────────────────────────┤
│  src/                                                       │
│  ├── index.ts              # Plugin export                  │
│  ├── plugin.ts             # Main plugin implementation     │
│  ├── auth/                                                  │
│  │   ├── oauth.ts          # Device code OAuth flow         │
│  │   ├── token.ts          # Session token exchange/refresh │
│  │   └── types.ts          # Auth types                     │
│  ├── provider/                                              │
│  │   ├── fetch.ts          # Custom fetch with headers      │
│  │   ├── headers.ts        # Header construction            │
│  │   └── initiator.ts      # X-Initiator determination      │
│  ├── models/                                                │
│  │   └── registry.ts       # Model fetching from /models    │
│  └── config/                                                │
│      └── schema.ts         # Plugin config schema           │
└─────────────────────────────────────────────────────────────┘
```

---

## Phase 1: Project Setup & Auth Foundation

### 1.1 Initialize npm package

Create package at `/home/nate/Projects/AgentTools/opencode/opencode-copilot-messages/`

```json
{
  "name": "opencode-copilot-messages",
  "version": "0.1.0",
  "type": "module",
  "main": "./dist/index.js",
  "dependencies": {
    "@opencode-ai/plugin": "^0.15.30",
    "@ai-sdk/anthropic": "latest",
    "zod": "^3.24.0"
  }
}
```

**Files:**

- `package.json`
- `tsconfig.json`
- `src/index.ts` (re-exports)

### 1.2 Implement Device Code OAuth Flow

**File:** `src/auth/oauth.ts`

```typescript
const CLIENT_ID = "Iv1.b507a08c87ecfe98";

// 1. POST https://github.com/login/device/code
//    body: { client_id, scope: "read:user" }  // Minimal scope
//    returns: { device_code, user_code, verification_uri, expires_in, interval }

// 2. Poll POST https://github.com/login/oauth/access_token
//    body: { client_id, device_code, grant_type: "urn:ietf:params:oauth:grant-type:device_code" }
//    until: access_token returned or expired
```

**RED Test:** Test OAuth flow returns device code, handles polling states (authorization_pending, slow_down), returns access_token on success.

### 1.3 Implement Session Token Exchange

**File:** `src/auth/token.ts`

Exchange GitHub PAT for Copilot session token:

```typescript
// POST https://api.github.com/copilot_internal/v2/token
// Headers:
//   Authorization: token ${githubToken}  // NOTE: "token" not "Bearer"
//   X-GitHub-Api-Version: 2025-04-01

// Response: { token, expires_at, refresh_in }
// Token format: "tid=...;exp=...:mac"
```

**Expiry handling (VSCode pattern for clock skew):**

```typescript
// Override expires_at to use refresh_in + buffer
const adjustedExpiresAt =
  Math.floor(Date.now() / 1000) + response.refresh_in + 60;
```

**Refresh logic:** If `adjustedExpiresAt < nowSeconds() + 300` (5 min buffer), refresh.

**RED Test:** Test token exchange, parsing, expiration detection, refresh trigger.

---

## Phase 2: Provider Integration

### 2.1 Implement Custom Fetch Wrapper

**File:** `src/provider/fetch.ts`

Wrap fetch to inject required headers and **strip x-api-key**:

```typescript
async function copilotMessagesFetch(
  input: RequestInfo | URL,
  init?: RequestInit,
  context: { sessionToken: string; ... }
): Promise<Response> {
  const headers = new Headers(init?.headers)

  // Strip x-api-key added by @ai-sdk/anthropic
  headers.delete("x-api-key")

  // Add Copilot headers
  const copilotHeaders = buildHeaders(context)
  for (const [key, value] of Object.entries(copilotHeaders)) {
    headers.set(key, value)
  }

  return fetch(input, { ...init, headers })
}
```

### 2.2 Implement Header Construction

**File:** `src/provider/headers.ts`

Required headers for `/v1/messages`:

```typescript
{
  "Authorization": `Bearer ${sessionToken}`,
  "User-Agent": `opencode/${version}`,
  "Editor-Version": `opencode/${version}`,
  "Editor-Plugin-Version": `copilot-messages/${pluginVersion}`,
  "Copilot-Integration-Id": "opencode",
  "X-Request-Id": crypto.randomUUID(),
  "X-Interaction-Type": "messages-proxy",      // FIXED: was conversation-agent
  "OpenAI-Intent": "messages-proxy",           // FIXED: was conversation-agent
  "X-GitHub-Api-Version": "2025-05-01",
  "X-Initiator": initiator,                    // Passed in, not computed here
  "anthropic-beta": "interleaved-thinking-2025-05-14",
  // Conditional:
  "Copilot-Vision-Request": "true"             // When images present
}
```

### 2.3 Implement X-Initiator Determination (CRITICAL)

**File:** `src/provider/initiator.ts`

**This is billing-critical.** `X-Initiator: user` = premium request (uses quota). `X-Initiator: agent` = not charged.

For Anthropic Messages API, `tool_result` blocks are in `role: user` messages. Check **only the last content block**:

```typescript
function determineInitiator(messages: AnthropicMessage[]): "user" | "agent" {
  const lastMsg = messages.at(-1);
  if (!lastMsg) return "agent";

  // Non-user role is always agent-initiated
  if (lastMsg.role !== "user") return "agent";

  // Check ONLY the last content block (not any tool_result)
  if (Array.isArray(lastMsg.content) && lastMsg.content.length > 0) {
    const lastBlock = lastMsg.content.at(-1);
    if (typeof lastBlock === "object" && lastBlock.type === "tool_result") {
      return "agent";
    }
  }

  // Actual user message
  return "user";
}
```

**Note:** Subagent detection is handled via `chat.headers` hook, not here.

**RED Test:** Test all cases:

- Pure user text message → "user"
- User message ending with tool_result → "agent"
- Mixed content with text AFTER tool_result → "user"
- Empty messages → "agent"

### 2.4 Implement chat.headers Hook for Subagents

**File:** `src/plugin.ts` (in hooks)

```typescript
"chat.headers": async (input, output) => {
  // Force agent initiator for subagent sessions
  if (input.message?.metadata?.parentSessionId) {
    output.headers["X-Initiator"] = "agent"
  }
}
```

---

## Phase 3: Model Registry

### 3.1 Fetch Models from /models Endpoint

**File:** `src/models/registry.ts`

```typescript
// GET https://api.github.com/copilot_internal/v2/models
// Headers: Authorization: Bearer ${sessionToken}
// Filter to: supported_endpoints includes "/v1/messages"
// Map to opencode model format
```

### 3.2 Map to OpenCode Model Format

Convert Copilot model metadata to opencode format with **correct shape**:

```typescript
{
  id: model.id,
  name: model.name,
  providerID: "copilot-messages",
  api: { npm: "@ai-sdk/anthropic" },
  cost: { input: 0, output: 0 },
  limit: {
    context: model.capabilities.limits.max_context_window_tokens,
    output: model.capabilities.limits.max_output_tokens
  },
  // Thinking config for variants
  options: {
    maxThinkingBudget: model.capabilities.supports.max_thinking_budget,
    minThinkingBudget: model.capabilities.supports.min_thinking_budget
  }
}
```

---

## Phase 4: Plugin Assembly

### 4.1 Main Plugin Implementation

**File:** `src/plugin.ts`

```typescript
import type { Plugin, Hooks, PluginInput } from "@opencode-ai/plugin"

export const CopilotMessagesPlugin: Plugin = async (input: PluginInput): Promise<Hooks> => {
  const pluginConfig = loadConfig(input.directory)

  return {
    // Register provider via config hook (runs before Provider.init)
    config: async (config) => {
      config.provider ??= {}
      config.provider["copilot-messages"] = {
        name: "Copilot Messages (Claude)",
        api: { name: "Anthropic" },
        models: {}  // Populated by loader
      }
    },

    // Handle subagent X-Initiator
    "chat.headers": async (input, output) => {
      if (input.provider?.info?.id !== "copilot-messages") return
      // Check for subagent session
      // Force X-Initiator: agent if subagent
    },

    auth: {
      provider: "copilot-messages",

      methods: [{
        type: "oauth",
        label: "GitHub Copilot (Messages API)",
        authorize: async () => {
          // Device code flow with CLIENT_ID
          // Token exchange
          // Return { refresh, access, expires }
        }
      }],

      loader: async (getAuth, provider) => {
        const auth = await getAuth()
        if (!isOAuthAuth(auth)) return {}

        // Refresh session token if needed
        const sessionToken = await ensureValidSessionToken(auth, input.client)

        // Fetch and register models
        const models = await fetchModels(sessionToken)
        for (const model of models) {
          provider.models[model.id] = model
        }

        return {
          apiKey: "",  // REQUIRED: Empty string to satisfy SDK
          baseURL: "https://api.copilot.com/v1",  // FIXED: Include /v1
          fetch: (req, init) => copilotMessagesFetch(req, init, { sessionToken, ... })
        }
      }
    }
  }
}
```

### 4.2 Export Structure

**File:** `src/index.ts`

```typescript
export { CopilotMessagesPlugin } from "./plugin";
export { determineInitiator } from "./provider/initiator";
export type { CopilotMessagesConfig } from "./config/schema";
```

---

## Phase 5: Configuration

### 5.1 Config Schema

**File:** `src/config/schema.ts`

```typescript
const configSchema = z.object({
  // Thinking budget override (uses model default if not set)
  thinking_budget: z.number().min(1024).max(32000).optional(),

  // Additional anthropic-beta features
  beta_features: z.array(z.string()).optional(),

  // Debug logging
  debug: z.boolean().default(false),
});
```

Config file location: `~/.config/opencode/copilot-messages.json`

---

## Critical Files to Reference

| Purpose                       | File Path                                                                         |
| ----------------------------- | --------------------------------------------------------------------------------- |
| Plugin API types              | `packages/plugin/src/index.ts`                                                    |
| Copilot auth plugin (pattern) | `packages/opencode/src/plugin/copilot.ts`                                         |
| AntiGravity plugin (template) | `AntiGravOAuth/opencode-antigravity-auth-fork/src/plugin.ts`                      |
| Provider loader               | `packages/opencode/src/provider/provider.ts:838-883`                              |
| Config provider loading       | `packages/opencode/src/provider/provider.ts:703-742`                              |
| Auth storage                  | `packages/opencode/src/auth/index.ts`                                             |
| VSCode token exchange         | `ref/vscode-copilot-chat/src/platform/authentication/node/copilotTokenManager.ts` |
| VSCode headers                | `ref/vscode-copilot-chat/src/platform/networking/common/networking.ts`            |
| VSCode X-Initiator            | `ref/vscode-copilot-chat/src/extension/prompt/node/chatMLFetcher.ts:704`          |

---

## Verification Plan

### Unit Tests

1. OAuth device code flow (mock GitHub endpoints)
2. Token exchange and refresh logic (including clock skew adjustment)
3. **X-Initiator determination** - all edge cases:
   - Pure user text message → "user"
   - User message with tool_result as LAST block → "agent"
   - Mixed content with text AFTER tool_result → "user"
   - Subagent session context → "agent" (via hook)
4. Header construction completeness (including vision header)
5. Model metadata parsing with correct limit.context/limit.output shape

### Integration Tests

1. Full OAuth flow with test account
2. Session token exchange
3. Model fetch from /models
4. Request to /v1/messages with valid auth

### End-to-End Verification

1. Install plugin: `opencode config plugin add opencode-copilot-messages`
2. Authenticate: `opencode auth login copilot-messages`
3. Select model: Switch to `claude-sonnet-4.5` under `copilot-messages` provider
4. Test conversation with tool use:
   - Verify X-Initiator headers in debug log
   - Confirm tool_result sends `X-Initiator: agent`
   - Confirm new user message sends `X-Initiator: user`
5. Monitor quota usage to verify billing correctness

---

## Resolved Questions

| Question                | Resolution                                                     |
| ----------------------- | -------------------------------------------------------------- |
| Provider ID             | `copilot-messages`                                             |
| Package name            | `opencode-copilot-messages`                                    |
| Thinking support        | Via opencode's model config system (variants + user config)    |
| Model registration      | Dynamic from `/models` endpoint                                |
| Client ID               | `Iv1.b507a08c87ecfe98`                                         |
| Token exchange endpoint | `https://api.github.com/copilot_internal/v2/token`             |
| Base URL                | `https://api.copilot.com/v1` (include /v1)                     |
| API Key                 | Set `apiKey: ""` and strip `x-api-key` header                  |
| X-Initiator logic       | Check LAST content block only                                  |
| Subagent detection      | Via `chat.headers` hook                                        |
| Provider registration   | Via `config` hook mutating `config.provider`                   |
| Model shape             | Use `limit.context` and `limit.output`                         |
| Vision header           | Include `Copilot-Vision-Request: true` when images present     |
| Token expiry            | Use `now + refresh_in + 60` for clock skew                     |
| OAuth scope             | `read:user` (minimal)                                          |
| Intent headers          | `messages-proxy` for both X-Interaction-Type and OpenAI-Intent |

---

## Implementation Order

1. **Phase 1.1-1.3**: Auth foundation (OAuth + token exchange with clock skew handling)
2. **Phase 2.3-2.4**: X-Initiator determination + chat.headers hook (billing-critical)
3. **Phase 2.1-2.2**: Fetch wrapper (strip x-api-key) + headers (messages-proxy intent)
4. **Phase 3**: Model registry with correct limit shape
5. **Phase 4**: Plugin assembly with config hook for provider registration
6. **Phase 5**: Configuration
7. **Verification**: Full test suite + E2E
