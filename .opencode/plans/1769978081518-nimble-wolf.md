# Plan: opencode-copilot-messages Plugin

## Overview

Create an optional plugin `opencode-copilot-messages` that provides an alternate auth/routing path for Claude models via Copilot's `/v1/messages` proxy endpoint (`api.copilot.com/v1/messages`). This uses the Anthropic Messages API format with `@ai-sdk/anthropic` and requires different credentials than the standard Copilot `/chat/completions` path.

**Provider ID:** `copilot-messages`
**Package Name:** `opencode-copilot-messages`

---

## Key Differences from Standard Copilot

| Aspect     | Standard Copilot         | This Plugin            |
| ---------- | ------------------------ | ---------------------- |
| Endpoint   | `/chat/completions`      | `/v1/messages`         |
| Client ID  | `Ov23li8tweQw6odWQebz`   | `Iv1.b507a08c87ecfe98` |
| SDK        | `@ai-sdk/github-copilot` | `@ai-sdk/anthropic`    |
| API Format | OpenAI Chat Completions  | Anthropic Messages API |
| Models     | All Copilot models       | Claude 4.x only        |

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│  opencode-copilot-messages                                  │
├─────────────────────────────────────────────────────────────┤
│  src/                                                       │
│  ├── index.ts              # Plugin export                  │
│  ├── plugin.ts             # Main plugin implementation     │
│  ├── auth/                                                  │
│  │   ├── oauth.ts          # Device code OAuth flow         │
│  │   ├── token.ts          # Session token exchange/refresh │
│  │   └── types.ts          # Auth types                     │
│  ├── provider/                                              │
│  │   ├── fetch.ts          # Custom fetch with headers      │
│  │   ├── headers.ts        # Header construction            │
│  │   └── initiator.ts      # X-Initiator determination      │
│  ├── models/                                                │
│  │   └── registry.ts       # Model fetching from /models    │
│  └── config/                                                │
│      └── schema.ts         # Plugin config schema           │
└─────────────────────────────────────────────────────────────┘
```

---

## Phase 1: Project Setup & Auth Foundation

### 1.1 Initialize npm package

Create package at `/home/nate/Projects/AgentTools/opencode/opencode-copilot-messages/`

```json
{
  "name": "opencode-copilot-messages",
  "version": "0.1.0",
  "type": "module",
  "main": "./dist/index.js",
  "dependencies": {
    "@opencode-ai/plugin": "^0.15.30",
    "@ai-sdk/anthropic": "latest",
    "zod": "^4.0.0"
  }
}
```

**Files:**

- `package.json`
- `tsconfig.json`
- `src/index.ts` (re-exports)

### 1.2 Implement Device Code OAuth Flow

**File:** `src/auth/oauth.ts`

```typescript
const CLIENT_ID = "Iv1.b507a08c87ecfe98"

// 1. POST https://github.com/login/device/code
//    body: { client_id, scope: "user:email" }
//    returns: { device_code, user_code, verification_uri, expires_in, interval }

// 2. Poll POST https://github.com/login/oauth/access_token
//    body: { client_id, device_code, grant_type: "urn:ietf:params:oauth:grant-type:device_code" }
//    until: access_token returned or expired
```

**RED Test:** Test OAuth flow returns device code, handles polling states (authorization_pending, slow_down), returns access_token on success.

### 1.3 Implement Session Token Exchange

**File:** `src/auth/token.ts`

Exchange GitHub PAT for Copilot session token:

```typescript
// POST https://api.github.com/copilot_internal/v2/token
// Headers:
//   Authorization: token ${githubToken}  // NOTE: "token" not "Bearer"
//   X-GitHub-Api-Version: 2025-04-01

// Response: { token, expires_at, refresh_in }
// Token format: "tid=...;exp=...:mac"
```

**Refresh logic:** If `expires_at < nowSeconds() + 300` (5 min buffer), refresh.

**RED Test:** Test token exchange, parsing, expiration detection, refresh trigger.

---

## Phase 2: Provider Integration

### 2.1 Implement Custom Fetch Wrapper

**File:** `src/provider/fetch.ts`

Wrap fetch to inject required headers and handle auth:

```typescript
async function copilotMessagesFetch(
  input: RequestInfo | URL,
  init?: RequestInit,
  context: { sessionToken: string; ... }
): Promise<Response> {
  const headers = buildHeaders(init?.headers, context)
  return fetch(input, { ...init, headers })
}
```

### 2.2 Implement Header Construction

**File:** `src/provider/headers.ts`

Required headers for `/v1/messages`:

```typescript
{
  "Authorization": `Bearer ${sessionToken}`,
  "User-Agent": `opencode/${version}`,
  "Editor-Version": `opencode/${version}`,
  "Editor-Plugin-Version": `copilot-messages/${pluginVersion}`,
  "Copilot-Integration-Id": "opencode",
  "X-Request-Id": crypto.randomUUID(),
  "X-Interaction-Type": "conversation-agent",
  "OpenAI-Intent": "conversation-agent",
  "X-GitHub-Api-Version": "2025-05-01",
  "X-Initiator": determineInitiator(messages),
  "anthropic-beta": "interleaved-thinking-2025-05-14"
}
```

### 2.3 Implement X-Initiator Determination (CRITICAL)

**File:** `src/provider/initiator.ts`

**This is billing-critical.** `X-Initiator: user` = premium request (uses quota). `X-Initiator: agent` = not charged.

For Anthropic Messages API, `tool_result` blocks are in `role: user` messages, so we must check content block type:

```typescript
function determineInitiator(messages: AnthropicMessage[]): "user" | "agent" {
  const lastMsg = messages.at(-1)

  // Non-user role is always agent-initiated
  if (lastMsg?.role !== "user") return "agent"

  // User role with tool_result content is agent-initiated
  if (Array.isArray(lastMsg.content)) {
    const hasToolResult = lastMsg.content.some((block) => typeof block === "object" && block.type === "tool_result")
    if (hasToolResult) return "agent"
  }

  // Actual user message
  return "user"
}
```

Also check for subagent context from opencode's request metadata.

**RED Test:** Test all cases - user text, tool_result, mixed content, subagent sessions.

---

## Phase 3: Model Registry

### 3.1 Fetch Models from /models Endpoint

**File:** `src/models/registry.ts`

```typescript
// GET https://api.github.com/copilot_internal/v2/models
// Filter to: supported_endpoints includes "/v1/messages"
// Map to opencode model format
```

Model response example shows:

- `id`: `claude-sonnet-4.5`
- `capabilities.family`: `claude-sonnet-4.5`
- `capabilities.supports.max_thinking_budget`: 32000
- `capabilities.supports.min_thinking_budget`: 1024
- `capabilities.limits.max_output_tokens`: 16000

### 3.2 Map to OpenCode Model Format

Convert Copilot model metadata to opencode format:

```typescript
{
  id: model.id,
  name: model.name,
  api: { npm: "@ai-sdk/anthropic" },
  cost: { input: 0, output: 0 },  // Free via Copilot
  context: model.capabilities.limits.max_context_window_tokens,
  // Thinking config from capabilities.supports
}
```

---

## Phase 4: Plugin Assembly

### 4.1 Main Plugin Implementation

**File:** `src/plugin.ts`

```typescript
import type { Plugin, Hooks, PluginInput } from "@opencode-ai/plugin"

export const CopilotMessagesPlugin: Plugin = async (input: PluginInput): Promise<Hooks> => {
  const config = loadConfig(input.directory)

  return {
    auth: {
      provider: "copilot-messages",

      methods: [{
        type: "oauth",
        label: "GitHub Copilot (Messages API)",
        authorize: async () => {
          // Device code flow
          // Token exchange
          // Return { refresh, access, expires }
        }
      }],

      loader: async (getAuth, provider) => {
        const auth = await getAuth()
        if (!isOAuthAuth(auth)) return {}

        // Refresh session token if needed
        const sessionToken = await ensureValidSessionToken(auth, input.client)

        // Fetch and register models
        const models = await fetchModels(sessionToken)
        for (const model of models) {
          provider.models[model.id] = model
        }

        return {
          baseURL: "https://api.copilot.com",
          fetch: (req, init) => copilotMessagesFetch(req, init, { sessionToken, ... })
        }
      }
    }
  }
}
```

### 4.2 Export Structure

**File:** `src/index.ts`

```typescript
export { CopilotMessagesPlugin } from "./plugin"
export { determineInitiator } from "./provider/initiator"
export type { CopilotMessagesConfig } from "./config/schema"
```

---

## Phase 5: Configuration

### 5.1 Config Schema

**File:** `src/config/schema.ts`

```typescript
const configSchema = z.object({
  // Thinking budget override (uses model default if not set)
  thinking_budget: z.number().min(1024).max(32000).optional(),

  // Additional anthropic-beta features
  beta_features: z.array(z.string()).optional(),

  // Debug logging
  debug: z.boolean().default(false),
})
```

Config file location: `~/.config/opencode/copilot-messages.json`

---

## Critical Files to Reference

| Purpose                       | File Path                                                                         |
| ----------------------------- | --------------------------------------------------------------------------------- |
| Plugin API types              | `packages/plugin/src/index.ts`                                                    |
| Copilot auth plugin (pattern) | `packages/opencode/src/plugin/copilot.ts`                                         |
| AntiGravity plugin (template) | `/home/nate/.../AntiGravOAuth/opencode-antigravity-auth-fork/src/plugin.ts`       |
| Provider loader               | `packages/opencode/src/provider/provider.ts:838-883`                              |
| Auth storage                  | `packages/opencode/src/auth/index.ts`                                             |
| VSCode token exchange         | `ref/vscode-copilot-chat/src/platform/authentication/node/copilotTokenManager.ts` |
| VSCode headers                | `ref/vscode-copilot-chat/src/platform/networking/common/networking.ts`            |
| VSCode X-Initiator            | `ref/vscode-copilot-chat/src/extension/prompt/node/chatMLFetcher.ts:704`          |

---

## Verification Plan

### Unit Tests

1. OAuth device code flow (mock GitHub endpoints)
2. Token exchange and refresh logic
3. **X-Initiator determination** - all edge cases:
   - Pure user text message
   - User message with tool_result block
   - Mixed user + tool_result content
   - Subagent session context
4. Header construction completeness
5. Model metadata parsing

### Integration Tests

1. Full OAuth flow with test account
2. Session token exchange
3. Model fetch from /models
4. Request to /v1/messages with valid auth

### End-to-End Verification

1. Install plugin: `opencode config plugin add opencode-copilot-messages`
2. Authenticate: `opencode auth login copilot-messages`
3. Select model: Switch to `claude-sonnet-4.5` under `copilot-messages` provider
4. Test conversation with tool use:
   - Verify X-Initiator headers in debug log
   - Confirm tool_result sends `X-Initiator: agent`
   - Confirm new user message sends `X-Initiator: user`
5. Monitor quota usage to verify billing correctness

---

## Open Questions (Resolved)

| Question                | Resolution                                                  |
| ----------------------- | ----------------------------------------------------------- |
| Provider ID             | `copilot-messages`                                          |
| Package name            | `opencode-copilot-messages`                                 |
| Thinking support        | Via opencode's model config system (variants + user config) |
| Model registration      | Dynamic from `/models` endpoint                             |
| Client ID               | `Iv1.b507a08c87ecfe98`                                      |
| Token exchange endpoint | `https://api.github.com/copilot_internal/v2/token`          |

---

## Implementation Order

1. **Phase 1.1-1.3**: Auth foundation (OAuth + token exchange)
2. **Phase 2.3**: X-Initiator determination (billing-critical, test thoroughly)
3. **Phase 2.1-2.2**: Fetch wrapper + headers
4. **Phase 3**: Model registry
5. **Phase 4**: Plugin assembly
6. **Phase 5**: Configuration
7. **Verification**: Full test suite + E2E
